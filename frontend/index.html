<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, interactive-widget=resizes-content" />
    <title>読み対戦 - Yomitaisen</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Sora:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://unpkg.com/wanakana"></script>
    <style>
      :root {
        /* Deep violet bg (280), purple accent (285) */
        --hue: 285;
        --hue-bg: 280;

        /* Background layers - dark violet */
        --bg-base: hsl(var(--hue-bg), 28%, 10%);
        --bg-elevated: hsl(var(--hue-bg), 23%, 14%);
        --bg-surface: hsl(var(--hue-bg), 18%, 18%);

        /* Borders - subtle purple */
        --border: hsl(var(--hue-bg), 25%, 21%);
        --border-subtle: hsl(var(--hue-bg), 20%, 17%);

        /* Text hierarchy - cool whites */
        --text-primary: hsl(var(--hue-bg), 8%, 92%);
        --text-secondary: hsl(var(--hue-bg), 12%, 55%);
        --text-muted: hsl(var(--hue-bg), 10%, 38%);

        /* Accent - deep magenta */
        --accent: hsl(305, 60%, 42%);
        --accent-hover: hsl(305, 58%, 38%);
        --accent-subtle: hsl(305, 45%, 16%);

        /* Secondary button */
        --secondary-bg: hsl(var(--hue-bg), 20%, 13%);
        --secondary-hover: hsl(var(--hue-bg), 25%, 19%);
        --secondary-border: hsl(var(--hue-bg), 30%, 25%);

        /* States */
        --disabled-bg: hsl(var(--hue-bg), 15%, 11%);
        --disabled-text: hsl(var(--hue-bg), 10%, 33%);
        --error: hsl(335, 55%, 50%);
      }

      * {
        box-sizing: border-box;
      }
      body {
        font-family: "Sora", "Noto Sans JP", sans-serif;
        max-width: 480px;
        margin: 0 auto;
        padding: 8px 20px 0;
        background: var(--bg-base);
        color: var(--text-primary);
        min-height: 100dvh;
        min-height: 100vh; /* fallback for browsers without dvh support */
      }
      @supports (min-height: 100dvh) {
        body {
          min-height: 100dvh;
        }
      }
      .card {
        padding: 0;
      }
      .logo {
        display: block;
        width: 540px;
        max-width: 100%;
        height: auto;
        margin: 0 auto;
      }
      .logo.in-game {
        width: 320px;
      }
      .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        border: 0;
      }
      .hidden {
        display: none !important;
      }
      input[type="text"] {
        width: 100%;
        padding: 12px;
        font-size: 1rem;
        font-family: inherit;
        border: 2px solid var(--border);
        border-radius: 8px;
        margin-bottom: 16px;
        background: var(--bg-elevated);
        color: var(--text-primary);
        flex-shrink: 0;
      }
      input[type="text"]:focus {
        outline: none;
        border-color: var(--accent);
      }
      input[type="text"]::placeholder {
        color: var(--text-muted);
      }
      button {
        width: 100%;
        padding: 12px;
        font-size: 1rem;
        font-family: inherit;
        background: var(--accent);
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
      }
      button:hover {
        background: var(--accent-hover);
      }
      button:disabled {
        background: var(--disabled-bg);
        color: var(--disabled-text);
        cursor: not-allowed;
      }
      button.secondary {
        background: var(--secondary-bg);
        color: var(--text-primary);
        border: 1px solid var(--secondary-border);
      }
      button.secondary:hover {
        background: var(--secondary-hover);
      }
      .divider {
        display: flex;
        align-items: center;
        color: var(--text-muted);
        margin: 20px 0;
        gap: 16px;
      }
      .divider::before,
      .divider::after {
        content: "";
        flex: 1;
        height: 1px;
        background: var(--border);
      }
      .status {
        text-align: center;
        color: var(--text-secondary);
        padding: 20px;
      }
      .game-code {
        text-align: center;
        font-size: 2.5rem;
        font-weight: 700;
        letter-spacing: 0.35em;
        text-indent: 0.35em;
        color: var(--accent);
        padding: 20px;
        background: var(--bg-elevated);
        border-radius: 8px;
        margin: 20px 0;
      }
      .game-code-label {
        text-align: center;
        color: var(--text-secondary);
      }
      #join-flow:not(.hidden) {
        display: flex;
        flex-direction: column;
        gap: 16px;
      }
      #join-flow input {
        margin-bottom: 0;
      }
      #join-flow .game-code {
        margin: 0;
      }
      .copy-link {
        margin-top: 16px;
      }
      #game-screen {
        display: flex;
        flex-direction: column;
        min-height: 0;
      }
      .kanji {
        font-size: 3rem;
        text-align: center;
        padding: 24px;
        line-height: 1;
        background: var(--bg-elevated);
        border-radius: 8px;
        margin-bottom: 16px;
        border: 1px solid var(--border-subtle);
        flex-shrink: 1;
        min-height: 0;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .opponent {
        text-align: center;
        color: var(--text-secondary);
        margin-bottom: 8px;
      }
      .scores {
        text-align: center;
        font-size: 1.5rem;
        font-weight: bold;
        margin-bottom: 8px;
        color: var(--accent);
      }
      .result {
        text-align: center;
        padding: 20px;
        font-size: 1.2rem;
      }
      .result.win {
        color: var(--accent);
      }
      .result.lose {
        color: var(--text-muted);
      }
      .correct-answer {
        text-align: center;
        color: var(--text-secondary);
        font-size: 1.2rem;
        margin-top: 10px;
      }
      .round-info {
        text-align: center;
        color: var(--text-muted);
        font-size: 0.9rem;
        margin-bottom: 8px;
      }
      .previous-word {
        text-align: center;
        padding: 10px;
        margin-bottom: 16px;
        border-radius: 8px;
        font-size: 0.95rem;
        background: var(--bg-elevated);
        border: 1px solid var(--border-subtle);
      }
      .previous-word.lose {
        border-color: var(--error);
        background: hsla(335, 55%, 50%, 0.1);
      }
      .previous-word .prev-kanji {
        font-size: 1.3rem;
        font-weight: bold;
      }
      .previous-word .prev-reading {
        color: var(--text-secondary);
        margin-left: 8px;
      }
      .previous-word .prev-result {
        font-size: 0.85rem;
        margin-top: 4px;
        color: var(--text-muted);
      }
      .connection-status {
        text-align: center;
        font-size: 0.8rem;
        color: var(--text-muted);
        margin-top: 20px;
      }
      .connection-status.connected {
        color: var(--accent);
      }
      .connection-status.disconnected {
        color: var(--text-muted);
      }
      .game-over {
        text-align: center;
        padding: 40px 30px;
      }
      .game-over h2 {
        font-size: 3rem;
        font-weight: 700;
        margin-bottom: 16px;
      }
      .game-over .scores {
        font-size: 2.5rem;
        margin-bottom: 32px;
      }
      .game-over.win h2,
      .game-over.win .scores {
        color: var(--accent);
      }
      .game-over.lose h2,
      .game-over.lose .scores {
        color: var(--text-muted);
      }
      .game-over.draw h2,
      .game-over.draw .scores {
        color: var(--text-secondary);
      }
      .error-message {
        text-align: center;
        color: var(--error);
        padding: 20px;
      }

      /* Lobby styles */
      .lobby-section {
        margin-top: 20px;
      }
      .lobby-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
      }
      .lobby-header h3 {
        margin: 0;
        font-size: 0.95rem;
        color: var(--text-secondary);
        font-weight: 500;
      }
      .refresh-btn {
        width: auto;
        padding: 6px 12px;
        font-size: 0.8rem;
        background: var(--secondary-bg);
        border: 1px solid var(--secondary-border);
      }
      .refresh-btn:hover {
        background: var(--secondary-hover);
      }
      .lobby-list {
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid var(--border);
        border-radius: 8px;
        background: var(--bg-elevated);
      }
      .lobby-empty {
        padding: 20px;
        text-align: center;
        color: var(--text-muted);
        font-size: 0.9rem;
      }
      .lobby-game {
        padding: 12px 16px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid var(--border-subtle);
        cursor: pointer;
        transition: background 0.15s;
      }
      .lobby-game:last-child {
        border-bottom: none;
      }
      .lobby-game:hover {
        background: var(--bg-surface);
      }
      .lobby-game-info {
        display: flex;
        flex-direction: column;
        gap: 2px;
      }
      .lobby-game-host {
        font-weight: 500;
        color: var(--text-primary);
      }
      .lobby-game-code {
        font-size: 0.8rem;
        color: var(--text-muted);
        font-family: monospace;
        letter-spacing: 0.1em;
      }
      .lobby-game-time {
        font-size: 0.85rem;
        color: var(--text-secondary);
      }

      /* Quick join modal */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        padding: 20px;
      }
      .modal-content {
        background: var(--bg-elevated);
        border-radius: 12px;
        padding: 24px;
        max-width: 360px;
        width: 100%;
        position: relative;
        border: 1px solid var(--border);
      }
      .modal-close {
        position: absolute;
        top: 12px;
        right: 12px;
        width: 32px;
        height: 32px;
        padding: 0;
        background: transparent;
        border: none;
        color: var(--text-muted);
        font-size: 1.5rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 4px;
      }
      .modal-close:hover {
        background: var(--bg-surface);
        color: var(--text-primary);
      }
      .modal-title {
        font-size: 1.2rem;
        font-weight: 600;
        margin-bottom: 20px;
        padding-right: 32px;
      }
      .modal-content input[type="text"] {
        margin-bottom: 16px;
      }

      @media (max-width: 480px) {
        body {
          padding: 8px 16px 0;
        }
      }
    </style>
  </head>
  <body>
    <div class="card">
      <img
        src="logo.png"
        alt=""
        class="logo"
        aria-hidden="true"
        onclick="goToLanding()"
        style="cursor: pointer"
      />
      <h1 class="sr-only">読み対戦 (Yomitaisen)</h1>

      <!-- Landing Screen -->
      <div id="landing-screen" style="margin-top: 24px">
        <input
          type="text"
          id="player-name"
          placeholder="Enter your name"
          autofocus
        />

        <!-- Default: Create game flow -->
        <div id="create-flow">
          <button id="create-btn" onclick="createGame()">
            Create New Game
          </button>

          <div class="divider">or join existing</div>

          <input
            type="text"
            id="game-code-input"
            placeholder="Enter game code"
            maxlength="6"
          />
          <button id="join-btn" class="secondary" onclick="joinGame()">
            Join Game
          </button>

          <!-- Lobby section -->
          <div id="lobby-section" class="lobby-section">
            <div class="lobby-header">
              <h3>Open Games</h3>
              <button class="refresh-btn" onclick="fetchLobby()">Refresh</button>
            </div>
            <div id="lobby-list" class="lobby-list">
              <div class="lobby-empty">Loading...</div>
            </div>
          </div>
        </div>

        <!-- Invite: Join game flow (shown when ?game=CODE in URL) -->
        <div id="join-flow" class="hidden">
          <div class="game-code-label">You've been invited to game:</div>
          <div class="game-code" id="invite-game-code"></div>
          <input
            type="text"
            id="player-name-join"
            placeholder="Enter your name"
          />
          <button id="join-invite-btn" onclick="joinGame()">Join Game</button>
        </div>
      </div>

      <!-- Lobby Screen (waiting for opponent) -->
      <div id="lobby-screen" class="hidden">
        <div class="game-code-label">Share this code with your friend:</div>
        <div class="game-code" id="lobby-game-code"></div>
        <button class="copy-link" onclick="copyLink()">Copy Link</button>
        <div class="status">Waiting for opponent...</div>
      </div>

      <!-- Error Screen -->
      <div id="error-screen" class="hidden">
        <div class="error-message" id="error-message"></div>
        <button onclick="backToLanding()">Back</button>
      </div>

      <!-- Game Screen -->
      <div id="game-screen" class="hidden">
        <div class="opponent">vs. <span id="opponent-name"></span></div>
        <div class="scores">
          <span id="my-score">0</span> - <span id="their-score">0</span>
        </div>
        <div class="round-info">
          Round <span id="round-number"></span> · <span id="timer">15</span>s
        </div>
        <div class="previous-word hidden" id="previous-word">
          <div>
            <span class="prev-kanji" id="prev-kanji" lang="ja"></span>
            <span class="prev-reading" id="prev-reading" lang="ja"></span>
          </div>
          <div class="prev-result" id="prev-result"></div>
        </div>
        <div class="kanji" id="kanji" lang="ja"></div>
        <input type="text" id="answer" placeholder="Type reading" lang="ja" />
        <div style="display: flex; gap: 16px; flex-shrink: 0">
          <button
            id="skip-btn"
            class="secondary"
            onclick="skipRound()"
            style="flex: 1"
          >
            Skip
          </button>
          <button id="submit-btn" onclick="submitAnswer()" style="flex: 1">
            Submit
          </button>
        </div>
      </div>

      <!-- Result Screen (brief, between rounds) -->
      <div id="result-screen" class="hidden">
        <div class="result" id="result-text"></div>
        <div class="correct-answer">
          Correct: <span id="correct-reading" lang="ja"></span>
        </div>
      </div>

      <!-- Game Over Screen -->
      <div id="game-over-screen" class="hidden">
        <div class="game-over" id="game-over-content">
          <h2 id="game-over-text"></h2>
          <div class="scores" id="final-scores"></div>
          <button id="rematch-btn" onclick="requestRematch()">
            Play Again
          </button>
        </div>
      </div>

      <div class="connection-status" id="connection-status">Disconnected</div>

      <!-- Quick Join Modal -->
      <div id="quick-join-modal" class="modal-overlay hidden" onclick="hideQuickJoinModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
          <button class="modal-close" onclick="hideQuickJoinModal()">&times;</button>
          <div class="modal-title">Join <span id="modal-host-name"></span>'s game</div>
          <input
            type="text"
            id="quick-join-name"
            placeholder="Enter your name"
            onkeypress="if(event.key==='Enter') quickJoin()"
          />
          <button onclick="quickJoin()">Join Game</button>
        </div>
      </div>
    </div>

    <script>
      // WebSocket URL: local dev uses localhost, production uses dedicated API domain
      const WS_URL =
        window.location.protocol === "file:"
          ? "ws://localhost:3000/ws/ephemeral"
          : "wss://yomi-api.alsvik.cloud/ws/ephemeral";
      const API_URL =
        window.location.protocol === "file:"
          ? "http://localhost:3000"
          : "https://yomi-api.alsvik.cloud";
      const ROUND_TIMEOUT = 30;
      const LOBBY_POLL_INTERVAL = 10000; // 10 seconds
      let ws = null;
      let lobbyPollInterval = null;
      let selectedGameId = null;
      let playerName = "";
      let opponentName = "";
      let gameId = "";
      let myScore = 0;
      let theirScore = 0;
      let timerInterval = null;
      let timeLeft = ROUND_TIMEOUT;
      let currentKanji = "";
      let currentReadings = []; // Valid readings for auto-submit
      let lastRoundResult = null; // { kanji, reading, winner, isMyWin }

      // Check URL for game code
      function getGameCodeFromURL() {
        const params = new URLSearchParams(window.location.search);
        return params.get("game") || "";
      }

      function startTimer() {
        stopTimer();
        timeLeft = ROUND_TIMEOUT;
        document.getElementById("timer").textContent = timeLeft;
        timerInterval = setInterval(() => {
          timeLeft--;
          document.getElementById("timer").textContent = timeLeft;
          if (timeLeft <= 0) stopTimer();
        }, 1000);
      }

      function stopTimer() {
        if (timerInterval) {
          clearInterval(timerInterval);
          timerInterval = null;
        }
      }

      // Sound effects using Web Audio API
      const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

      function playTone(frequency, duration, type = "sine") {
        const oscillator = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();

        oscillator.connect(gainNode);
        gainNode.connect(audioCtx.destination);

        oscillator.frequency.value = frequency;
        oscillator.type = type;

        gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(
          0.01,
          audioCtx.currentTime + duration,
        );

        oscillator.start(audioCtx.currentTime);
        oscillator.stop(audioCtx.currentTime + duration);
      }

      function playWinSound() {
        playTone(523, 0.1); // C5
        setTimeout(() => playTone(659, 0.1), 100); // E5
        setTimeout(() => playTone(784, 0.15), 200); // G5
      }

      function playLoseSound() {
        playTone(392, 0.15); // G4
        setTimeout(() => playTone(330, 0.2), 150); // E4
      }

      function playSkipSound() {
        playTone(294, 0.12); // D4 - neutral, lower tone
        setTimeout(() => playTone(262, 0.15), 100); // C4
      }

      function playCountdownBeep() {
        playTone(440, 0.08); // A4 - short tick
      }

      function playCountdownGo() {
        playTone(880, 0.15); // A5 - higher pitch for "go"
      }

      function runCountdown(onComplete) {
        const kanjiEl = document.getElementById("kanji");
        let count = 3;

        kanjiEl.textContent = count;
        playCountdownBeep();

        const interval = setInterval(() => {
          count--;
          if (count > 0) {
            kanjiEl.textContent = count;
            playCountdownBeep();
          } else {
            clearInterval(interval);
            playCountdownGo();
            onComplete();
          }
        }, 1000);
      }

      function showScreen(screenId) {
        [
          "landing-screen",
          "lobby-screen",
          "error-screen",
          "game-screen",
          "result-screen",
          "game-over-screen",
        ].forEach((id) => {
          document.getElementById(id).classList.add("hidden");
        });
        document.getElementById(screenId).classList.remove("hidden");

        // Smaller logo when in game
        const logo = document.querySelector(".logo");
        const inGameScreens = ["game-screen", "result-screen"];
        logo.classList.toggle("in-game", inGameScreens.includes(screenId));
      }

      function updateScores() {
        document.getElementById("my-score").textContent = myScore;
        document.getElementById("their-score").textContent = theirScore;
      }

      function setConnectionStatus(connected) {
        const el = document.getElementById("connection-status");
        el.textContent = connected ? "Connected" : "Disconnected";
        el.className =
          "connection-status " + (connected ? "connected" : "disconnected");
      }

      function connect() {
        return new Promise((resolve, reject) => {
          ws = new WebSocket(WS_URL);

          ws.onopen = () => {
            console.log("Connected to server");
            setConnectionStatus(true);
            resolve();
          };

          ws.onclose = () => {
            console.log("Disconnected from server");
            setConnectionStatus(false);
          };

          ws.onerror = (err) => {
            console.error("WebSocket error:", err);
            setConnectionStatus(false);
            reject(err);
          };

          ws.onmessage = (event) => {
            const msg = JSON.parse(event.data);
            console.log("Received:", msg);
            handleMessage(msg);
          };
        });
      }

      function handleMessage(msg) {
        switch (msg.type) {
          case "game_created":
            gameId = msg.game_id;
            sessionStorage.setItem("createdGameId", gameId);
            document.getElementById("lobby-game-code").textContent =
              gameId.toUpperCase();
            // Update URL without reload
            history.replaceState(null, "", `?game=${gameId}`);
            break;

          case "waiting_for_opponent":
            showScreen("lobby-screen");
            break;

          case "opponent_joined":
            opponentName = msg.opponent_name;
            break;

          case "game_not_found":
            showError("Game not found. Check the code and try again.");
            break;

          case "game_full":
            showError("This game is already full.");
            break;

          case "game_start":
            opponentName = opponentName || msg.opponent;
            document.getElementById("opponent-name").textContent = opponentName;
            myScore = 0;
            theirScore = 0;
            lastRoundResult = null;
            currentKanji = "";
            updateScores();
            // Reset rematch button in case this is a rematch
            document.getElementById("rematch-btn").textContent = "Play Again";
            document.getElementById("rematch-btn").disabled = false;
            break;

          case "round_start":
            document.getElementById("round-number").textContent = msg.round;
            currentKanji = msg.kanji;
            currentReadings = msg.readings || [];
            document.getElementById("answer").value = "";
            document.getElementById("submit-btn").disabled = true;
            document.getElementById("skip-btn").disabled = true;
            document.getElementById("skip-btn").textContent = "Skip";
            updateScores();

            // Show previous round result (or placeholder on first round)
            const prevWordEl = document.getElementById("previous-word");
            if (lastRoundResult) {
              document.getElementById("prev-kanji").textContent =
                lastRoundResult.kanji;
              document.getElementById("prev-reading").textContent =
                lastRoundResult.reading;
              document.getElementById("prev-result").textContent =
                lastRoundResult.resultText;
              prevWordEl.className =
                "previous-word " + lastRoundResult.resultClass;
            } else {
              document.getElementById("prev-kanji").textContent = "";
              document.getElementById("prev-reading").textContent =
                "First to 10 wins!";
              document.getElementById("prev-result").textContent = "";
              prevWordEl.className = "previous-word";
            }
            prevWordEl.classList.remove("hidden");

            showScreen("game-screen");

            // Run 3-2-1 countdown only for round 1
            if (msg.round === 1) {
              runCountdown(() => {
                document.getElementById("kanji").textContent = currentKanji;
                document.getElementById("submit-btn").disabled = false;
                document.getElementById("skip-btn").disabled = false;
                document.getElementById("answer").focus();
                startTimer();
              });
            } else {
              document.getElementById("kanji").textContent = currentKanji;
              document.getElementById("submit-btn").disabled = false;
              document.getElementById("skip-btn").disabled = false;
              document.getElementById("answer").focus();
              startTimer();
            }
            break;

          case "round_result":
            stopTimer();
            if (msg.winner === playerName) {
              myScore++;
              playWinSound();
            } else if (msg.winner) {
              theirScore++;
              playLoseSound();
            } else {
              playSkipSound();
            }
            updateScores();

            // Store result to show on next round
            const isWinner = msg.winner === playerName;
            let prevResultText, prevResultClass;
            if (msg.winner) {
              prevResultText = isWinner
                ? "✓ You got it!"
                : `✗ ${opponentName} got it`;
              prevResultClass = isWinner ? "win" : "lose";
            } else {
              prevResultText = "— Skipped";
              prevResultClass = "timeout";
            }
            lastRoundResult = {
              kanji: currentKanji,
              reading: msg.correct_reading,
              resultText: prevResultText,
              resultClass: prevResultClass,
            };

            // Disable inputs while waiting for next round
            document.getElementById("submit-btn").disabled = true;
            document.getElementById("skip-btn").disabled = true;
            break;

          case "wrong_answer":
            document.getElementById("submit-btn").disabled = false;
            document.getElementById("skip-btn").disabled = false;
            document.getElementById("answer").value = "";
            document.getElementById("answer").focus();
            break;

          case "skip_waiting":
            document.getElementById("skip-btn").textContent = "Waiting...";
            document.getElementById("skip-btn").disabled = true;
            break;

          case "rematch_waiting":
            // Already handled in requestRematch() - button shows "Waiting..."
            break;

          case "game_end":
            stopTimer();
            const gameOverContent =
              document.getElementById("game-over-content");
            let resultText;
            let resultClass;
            if (!msg.winner) {
              resultText = "Draw!";
              resultClass = "draw";
            } else if (msg.winner === playerName) {
              resultText = "You Win!";
              resultClass = "win";
            } else {
              resultText = "You Lose!";
              resultClass = "lose";
            }
            gameOverContent.className = "game-over " + resultClass;
            document.getElementById("game-over-text").textContent = resultText;
            document.getElementById("final-scores").textContent =
              `${myScore} - ${theirScore}`;
            showScreen("game-over-screen");
            break;

          case "opponent_disconnected":
            alert("Opponent disconnected");
            location.reload();
            break;
        }
      }

      function showError(message) {
        document.getElementById("error-message").textContent = message;
        showScreen("error-screen");
      }

      function backToLanding() {
        sessionStorage.removeItem("createdGameId");
        showCreateFlow();
        showScreen("landing-screen");
        document.getElementById("create-btn").disabled = false;
        document.getElementById("join-btn").disabled = false;
        document.getElementById("join-invite-btn").disabled = false;
      }

      function isInGame() {
        const gameScreen = document.getElementById("game-screen");
        const resultScreen = document.getElementById("result-screen");
        return (
          !gameScreen.classList.contains("hidden") ||
          !resultScreen.classList.contains("hidden")
        );
      }

      function goToLanding() {
        if (isInGame()) {
          if (!confirm("Leave the current game?")) {
            return;
          }
        }
        sessionStorage.removeItem("createdGameId");
        window.location.href = window.location.pathname;
      }

      async function createGame() {
        playerName = document.getElementById("player-name").value.trim();
        if (!playerName) {
          alert("Please enter your name");
          return;
        }

        document.getElementById("create-btn").disabled = true;
        stopLobbyPolling();

        try {
          if (!ws || ws.readyState !== WebSocket.OPEN) {
            await connect();
          }
          ws.send(
            JSON.stringify({
              type: "create_game",
              player_name: playerName,
            }),
          );
        } catch (err) {
          showError("Could not connect to server");
          document.getElementById("create-btn").disabled = false;
          startLobbyPolling();
        }
      }

      async function joinGame() {
        // Check both name inputs (create flow vs join flow)
        playerName =
          document.getElementById("player-name").value.trim() ||
          document.getElementById("player-name-join").value.trim();
        const code = document
          .getElementById("game-code-input")
          .value.trim()
          .toLowerCase();

        if (!playerName) {
          alert("Please enter your name");
          return;
        }
        if (!code || code.length !== 6) {
          alert("Please enter a valid 6-character game code");
          return;
        }

        document.getElementById("join-btn").disabled = true;
        document.getElementById("join-invite-btn").disabled = true;
        stopLobbyPolling();

        try {
          if (!ws || ws.readyState !== WebSocket.OPEN) {
            await connect();
          }
          ws.send(
            JSON.stringify({
              type: "join_game",
              game_id: code,
              player_name: playerName,
            }),
          );
        } catch (err) {
          showError("Could not connect to server");
          document.getElementById("join-btn").disabled = false;
          document.getElementById("join-invite-btn").disabled = false;
          startLobbyPolling();
        }
      }

      function copyLink() {
        const url = window.location.href;
        navigator.clipboard.writeText(url).then(() => {
          const btn = document.querySelector(".copy-link");
          const originalText = btn.textContent;
          btn.textContent = "Copied!";
          setTimeout(() => {
            btn.textContent = originalText;
          }, 2000);
        });
      }

      function submitAnswer() {
        const rawAnswer = document.getElementById("answer").value.trim();
        if (!rawAnswer) return;

        // Normalize: convert romaji/katakana to hiragana
        const answer = wanakana.toHiragana(rawAnswer, { IMEMode: true });

        ws.send(
          JSON.stringify({
            type: "answer",
            answer: answer,
          }),
        );
        document.getElementById("submit-btn").disabled = true;
      }

      function skipRound() {
        ws.send(JSON.stringify({ type: "skip" }));
        document.getElementById("submit-btn").disabled = true;
        document.getElementById("skip-btn").disabled = true;
      }

      function requestRematch() {
        ws.send(JSON.stringify({ type: "request_rematch" }));
        document.getElementById("rematch-btn").textContent = "Waiting...";
        document.getElementById("rematch-btn").disabled = true;
      }

      // Event listeners
      document
        .getElementById("player-name")
        .addEventListener("keypress", (e) => {
          if (e.key === "Enter") {
            const codeInput = document.getElementById("game-code-input").value;
            if (codeInput) {
              joinGame();
            } else {
              createGame();
            }
          }
        });

      document
        .getElementById("game-code-input")
        .addEventListener("keypress", (e) => {
          if (e.key === "Enter") joinGame();
        });

      document
        .getElementById("player-name-join")
        .addEventListener("keypress", (e) => {
          if (e.key === "Enter") joinGame();
        });

      document.getElementById("answer").addEventListener("keypress", (e) => {
        if (e.key === "Enter") submitAnswer();
      });

      function showCreateFlow() {
        document.getElementById("player-name").classList.remove("hidden");
        document.getElementById("create-flow").classList.remove("hidden");
        document.getElementById("join-flow").classList.add("hidden");
        document.getElementById("game-code-input").value = "";
        history.replaceState(null, "", window.location.pathname);
        startLobbyPolling();
      }

      function showJoinFlow(code) {
        document.getElementById("player-name").classList.add("hidden");
        document.getElementById("create-flow").classList.add("hidden");
        document.getElementById("join-flow").classList.remove("hidden");
        document.getElementById("invite-game-code").textContent =
          code.toUpperCase();
        document.getElementById("game-code-input").value = code;
        document.getElementById("player-name-join").focus();
      }

      // Lobby functions
      async function fetchLobby() {
        try {
          const response = await fetch(`${API_URL}/lobby`);
          if (!response.ok) throw new Error("Failed to fetch lobby");
          const data = await response.json();
          renderLobby(data.games);
        } catch (err) {
          console.error("Lobby fetch error:", err);
          renderLobby([]);
        }
      }

      function renderLobby(games) {
        const listEl = document.getElementById("lobby-list");
        if (!games || games.length === 0) {
          listEl.innerHTML = '<div class="lobby-empty">No open games</div>';
          return;
        }

        listEl.innerHTML = games
          .map((game) => {
            const waitTime = formatWaitTime(game.created_at_secs);
            return `
              <div class="lobby-game" onclick="showQuickJoinModal('${game.game_id}', '${escapeHtml(game.host_name)}')">
                <div class="lobby-game-info">
                  <span class="lobby-game-host">${escapeHtml(game.host_name)}</span>
                  <span class="lobby-game-code">${game.game_id.toUpperCase()}</span>
                </div>
                <span class="lobby-game-time">${waitTime}</span>
              </div>
            `;
          })
          .join("");
      }

      function formatWaitTime(seconds) {
        if (seconds < 60) return "just now";
        const minutes = Math.floor(seconds / 60);
        return `${minutes}m ago`;
      }

      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      function startLobbyPolling() {
        stopLobbyPolling();
        fetchLobby();
        lobbyPollInterval = setInterval(fetchLobby, LOBBY_POLL_INTERVAL);
      }

      function stopLobbyPolling() {
        if (lobbyPollInterval) {
          clearInterval(lobbyPollInterval);
          lobbyPollInterval = null;
        }
      }

      function showQuickJoinModal(gameId, hostName) {
        selectedGameId = gameId;
        document.getElementById("modal-host-name").textContent = hostName;
        // Pre-fill name if already entered
        const existingName = document.getElementById("player-name").value.trim();
        const quickJoinInput = document.getElementById("quick-join-name");
        quickJoinInput.value = existingName;
        document.getElementById("quick-join-modal").classList.remove("hidden");
        quickJoinInput.focus();
      }

      function hideQuickJoinModal(event) {
        // If called from overlay click, only close if clicking overlay itself
        if (event && event.target !== event.currentTarget) return;
        document.getElementById("quick-join-modal").classList.add("hidden");
        selectedGameId = null;
      }

      async function quickJoin() {
        playerName = document.getElementById("quick-join-name").value.trim();
        if (!playerName) {
          alert("Please enter your name");
          return;
        }
        if (!selectedGameId) return;

        // Capture game ID before hiding modal (which clears selectedGameId)
        const gameId = selectedGameId;

        // Also update the main name field for consistency
        document.getElementById("player-name").value = playerName;

        hideQuickJoinModal();
        stopLobbyPolling();

        try {
          if (!ws || ws.readyState !== WebSocket.OPEN) {
            await connect();
          }
          ws.send(
            JSON.stringify({
              type: "join_game",
              game_id: gameId,
              player_name: playerName,
            }),
          );
        } catch (err) {
          showError("Could not connect to server");
          startLobbyPolling();
        }
      }

      // Initialize
      const urlGameCode = getGameCodeFromURL();
      const myCreatedGame = sessionStorage.getItem("createdGameId");
      if (urlGameCode) {
        // If this is our own game, go to landing instead of showing join flow
        if (
          myCreatedGame &&
          myCreatedGame.toLowerCase() === urlGameCode.toLowerCase()
        ) {
          sessionStorage.removeItem("createdGameId");
          showCreateFlow();
        } else {
          showJoinFlow(urlGameCode);
        }
      } else {
        // No game code in URL, start lobby polling
        startLobbyPolling();
      }

      // Bind wanakana to answer input for real-time romaji→hiragana conversion
      const answerInput = document.getElementById("answer");
      wanakana.bind(answerInput, { IMEMode: true });

      // Auto-submit when input matches a valid reading
      answerInput.addEventListener("input", () => {
        const value = answerInput.value.trim();
        if (value && currentReadings.includes(value)) {
          submitAnswer();
        }
      });
    </script>
  </body>
</html>
