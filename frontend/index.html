<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>読み対戦 - Yomitaisen</title>
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 400px;
            margin: 40px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h1 {
            margin: 0 0 20px 0;
            font-size: 1.5rem;
            text-align: center;
        }
        .hidden {
            display: none;
        }
        input[type="text"] {
            width: 100%;
            padding: 12px;
            font-size: 1rem;
            border: 2px solid #ddd;
            border-radius: 8px;
            margin-bottom: 12px;
        }
        input[type="text"]:focus {
            outline: none;
            border-color: #007aff;
        }
        button {
            width: 100%;
            padding: 12px;
            font-size: 1rem;
            background: #007aff;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .status {
            text-align: center;
            color: #666;
            padding: 20px;
        }
        .kanji {
            font-size: 4rem;
            text-align: center;
            padding: 30px;
            background: #f9f9f9;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .opponent {
            text-align: center;
            color: #666;
            margin-bottom: 10px;
        }
        .scores {
            text-align: center;
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .result {
            text-align: center;
            padding: 20px;
            font-size: 1.2rem;
        }
        .result.win {
            color: #28a745;
        }
        .result.lose {
            color: #dc3545;
        }
        .correct-answer {
            text-align: center;
            color: #666;
            font-size: 1.2rem;
            margin-top: 10px;
        }
        .round-info {
            text-align: center;
            color: #999;
            font-size: 0.9rem;
            margin-bottom: 10px;
        }
        .connection-status {
            text-align: center;
            font-size: 0.8rem;
            color: #999;
            margin-top: 20px;
        }
        .connection-status.connected {
            color: #28a745;
        }
        .connection-status.disconnected {
            color: #dc3545;
        }
        .game-over {
            text-align: center;
            padding: 30px;
        }
        .game-over h2 {
            font-size: 2rem;
            margin-bottom: 20px;
        }
        .game-over.win h2 {
            color: #28a745;
        }
        .game-over.lose h2 {
            color: #dc3545;
        }
    </style>
</head>
<body>
    <div class="card">
        <h1><ruby>読み対戦<rp>(</rp><rt>yomitaisen</rt><rp>)</rp></ruby></h1>

        <!-- Join Screen -->
        <div id="join-screen">
            <input type="text" id="username" placeholder="Enter username" autofocus>
            <button id="join-btn" onclick="join()">Join Game</button>
        </div>

        <!-- Waiting Screen -->
        <div id="waiting-screen" class="hidden">
            <div class="status">Waiting for opponent...</div>
        </div>

        <!-- Game Screen -->
        <div id="game-screen" class="hidden">
            <div class="opponent">vs. <span id="opponent-name"></span></div>
            <div class="scores"><span id="my-score">0</span> - <span id="their-score">0</span></div>
            <div class="round-info">Round <span id="round-number"></span></div>
            <div class="kanji" id="kanji"></div>
            <input type="text" id="answer" placeholder="Type reading in hiragana">
            <button id="submit-btn" onclick="submitAnswer()">Submit</button>
        </div>

        <!-- Result Screen (brief, between rounds) -->
        <div id="result-screen" class="hidden">
            <div class="result" id="result-text"></div>
            <div class="correct-answer">Correct: <span id="correct-reading"></span></div>
        </div>

        <!-- Game Over Screen -->
        <div id="game-over-screen" class="hidden">
            <div class="game-over" id="game-over-content">
                <h2 id="game-over-text"></h2>
                <div class="scores" id="final-scores"></div>
                <button onclick="location.reload()">Play Again</button>
            </div>
        </div>

        <div class="connection-status" id="connection-status">Disconnected</div>
    </div>

    <script>
        const WS_URL = 'ws://localhost:3000/ws';
        let ws = null;
        let username = '';
        let opponentName = '';
        let myScore = 0;
        let theirScore = 0;

        function showScreen(screenId) {
            ['join-screen', 'waiting-screen', 'game-screen', 'result-screen', 'game-over-screen'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            document.getElementById(screenId).classList.remove('hidden');
        }

        function updateScores() {
            document.getElementById('my-score').textContent = myScore;
            document.getElementById('their-score').textContent = theirScore;
        }

        function setConnectionStatus(connected) {
            const el = document.getElementById('connection-status');
            el.textContent = connected ? 'Connected' : 'Disconnected';
            el.className = 'connection-status ' + (connected ? 'connected' : 'disconnected');
        }

        function connect() {
            ws = new WebSocket(WS_URL);

            ws.onopen = () => {
                console.log('Connected to server');
                setConnectionStatus(true);
            };

            ws.onclose = () => {
                console.log('Disconnected from server');
                setConnectionStatus(false);
            };

            ws.onerror = (err) => {
                console.error('WebSocket error:', err);
                setConnectionStatus(false);
            };

            ws.onmessage = (event) => {
                const msg = JSON.parse(event.data);
                console.log('Received:', msg);
                handleMessage(msg);
            };
        }

        function handleMessage(msg) {
            switch (msg.type) {
                case 'waiting':
                    showScreen('waiting-screen');
                    break;

                case 'game_start':
                    opponentName = msg.opponent;
                    document.getElementById('opponent-name').textContent = opponentName;
                    myScore = 0;
                    theirScore = 0;
                    updateScores();
                    break;

                case 'round_start':
                    document.getElementById('round-number').textContent = msg.round;
                    document.getElementById('kanji').textContent = msg.kanji;
                    document.getElementById('answer').value = '';
                    document.getElementById('submit-btn').disabled = false;
                    updateScores();
                    showScreen('game-screen');
                    document.getElementById('answer').focus();
                    break;

                case 'round_result':
                    // Update scores
                    if (msg.winner === username) {
                        myScore++;
                    } else if (msg.winner) {
                        theirScore++;
                    }
                    updateScores();

                    // Show result briefly
                    const isWinner = msg.winner === username;
                    const resultEl = document.getElementById('result-text');
                    resultEl.textContent = msg.winner
                        ? (isWinner ? 'Correct!' : `${msg.winner} got it!`)
                        : 'Time out!';
                    resultEl.className = 'result ' + (isWinner ? 'win' : 'lose');
                    document.getElementById('correct-reading').textContent = msg.correct_reading;
                    showScreen('result-screen');
                    // Next round will come automatically via round_start or game_end
                    break;

                case 'wrong_answer':
                    document.getElementById('submit-btn').disabled = false;
                    document.getElementById('answer').value = '';
                    document.getElementById('answer').focus();
                    break;

                case 'game_end':
                    const didWin = msg.winner === username;
                    const gameOverContent = document.getElementById('game-over-content');
                    gameOverContent.className = 'game-over ' + (didWin ? 'win' : 'lose');
                    document.getElementById('game-over-text').textContent = didWin ? 'You Win!' : 'You Lose!';
                    document.getElementById('final-scores').textContent = `${myScore} - ${theirScore}`;
                    showScreen('game-over-screen');
                    break;
            }
        }

        function join() {
            username = document.getElementById('username').value.trim();
            if (!username) {
                alert('Please enter a username');
                return;
            }

            if (!ws || ws.readyState !== WebSocket.OPEN) {
                connect();
                ws.onopen = () => {
                    setConnectionStatus(true);
                    sendJoin();
                };
            } else {
                sendJoin();
            }
        }

        function sendJoin() {
            ws.send(JSON.stringify({
                type: 'join',
                user_id: username
            }));
            document.getElementById('join-btn').disabled = true;
        }

        function submitAnswer() {
            const answer = document.getElementById('answer').value.trim();
            if (!answer) return;

            ws.send(JSON.stringify({
                type: 'answer',
                answer: answer
            }));
            document.getElementById('submit-btn').disabled = true;
        }

        document.getElementById('username').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') join();
        });

        document.getElementById('answer').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') submitAnswer();
        });

        connect();
    </script>
</body>
</html>
